generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model app_users {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider         String
  provider_user_id String
  nickname         String?
  email            String?
  created_at       DateTime          @default(now()) @db.Timestamptz(6)
  battles          battles[]
  characters       characters[]
  user_characters  user_characters[]

  @@unique([provider, provider_user_id])
}

model battles {
  id                                                     String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  challenger_user_id                                     String     @db.Uuid
  challenger_character_id                                String     @db.Uuid
  target_character_id                                    String     @db.Uuid
  winner_side                                            String
  score_challenger                                       Decimal?   @db.Decimal
  score_target                                           Decimal?   @db.Decimal
  log_json                                               Json?
  created_at                                             DateTime   @default(now()) @db.Timestamptz(6)
  attacker_character_id                                  String?    @db.Uuid
  defender_character_id                                  String?    @db.Uuid
  winner_character_id                                    String?    @db.Uuid
  winrate_a                                              Float?
  winrate_b                                              Float?
  score_a                                                Float?
  score_b                                                Float?
  delta                                                  Float?
  highlights                                             Json?
  characters_battles_challenger_character_idTocharacters characters @relation("battles_challenger_character_idTocharacters", fields: [challenger_character_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  app_users                                              app_users  @relation(fields: [challenger_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  characters_battles_target_character_idTocharacters     characters @relation("battles_target_character_idTocharacters", fields: [target_character_id], references: [id], onUpdate: NoAction)

  @@index([challenger_user_id, created_at(sort: Desc)], map: "battles_challenger_user_idx")
  @@index([target_character_id, created_at(sort: Desc)], map: "battles_target_character_idx")
  @@index([attacker_character_id, created_at], map: "idx_battles_attacker_created")
  @@index([defender_character_id, created_at], map: "idx_battles_defender_created")
  @@index([winner_character_id, created_at], map: "idx_battles_winner_created")
}

model character_profiles {
  id                      String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  server_id               String
  dnf_character_id        String
  character_name          String
  job_name                String?
  level                   Int?
  last_image_url          String?
  last_ai_image_url       String?
  last_analysis           String?
  battle_tags             String[]          @default([])
  battle_stats            Json?
  battle_stats_version    Int               @default(1)
  battle_stats_updated_at DateTime?         @db.Timestamptz(6)
  created_at              DateTime          @default(now()) @db.Timestamptz(6)
  updated_at              DateTime          @default(now()) @updatedAt @db.Timestamptz(6)
  user_characters         user_characters[]

  @@unique([server_id, dnf_character_id], map: "character_profiles_server_dnf_uidx")
  @@index([server_id, character_name], map: "character_profiles_server_name_idx")
}

model user_characters {
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String             @db.Uuid
  profile_id String             @db.Uuid
  wins       Int                @default(0)
  is_main    Boolean            @default(false)
  slot_index Int?
  bg_key     String?
  created_at DateTime           @default(now()) @db.Timestamptz(6)
  updated_at DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  profile    character_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_characters_profile_fk")
  user       app_users          @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "user_characters_user_fk")

  @@unique([user_id, profile_id], map: "user_characters_user_profile_uidx")
  @@index([profile_id], map: "user_characters_profile_idx")
  @@index([user_id], map: "user_characters_user_idx")
}
