generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model app_users {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider         String
  provider_user_id String
  nickname         String?
  email            String?
  created_at       DateTime @default(now()) @db.Timestamptz(6)

  // 계정 공용 재화
  gold Int @default(0)

  user_characters user_characters[]
  battles         battles[]

  inventory user_inventory[]

  @@unique([provider, provider_user_id])
}

enum BattleMode {
  PVE
  PVP
}

enum BattleTargetKind {
  USER
  MONSTER
}

model battles {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mode        BattleMode
  target_kind BattleTargetKind

  // 요청자(유저)
  challenger_user_id String @db.Uuid
  challenger_uc_id   String @db.Uuid

  // 타겟(PVP면 USER, PVE면 MONSTER)
  target_uc_id       String? @db.Uuid
  target_monster_key String?
  target_monster_lvl Int?

  // 결과
  winner_uc_id String? @db.Uuid
  winrate_a    Float?
  winrate_b    Float?
  score_a      Float?
  score_b      Float?
  delta_rating Int? // PVP에서 레이팅 변화량(+/-)

  highlights Json?
  log_json   Json?

  created_at DateTime @default(now()) @db.Timestamptz(6)

  // relations
  challenger_user app_users @relation(fields: [challenger_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  challenger_uc user_characters  @relation("battles_challenger_uc", fields: [challenger_uc_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  target_uc     user_characters? @relation("battles_target_uc", fields: [target_uc_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  winner_uc     user_characters? @relation("battles_winner_uc", fields: [winner_uc_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([challenger_user_id, created_at(sort: Desc)], map: "battles_challenger_user_idx")
  @@index([challenger_uc_id, created_at(sort: Desc)], map: "battles_challenger_uc_idx")
  @@index([target_uc_id, created_at(sort: Desc)], map: "battles_target_uc_idx")
  @@index([winner_uc_id, created_at(sort: Desc)], map: "battles_winner_uc_idx")
  @@index([mode, created_at(sort: Desc)], map: "battles_mode_created_idx")
}

model character_profiles {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  server_id         String
  dnf_character_id  String
  character_name    String
  job_name          String?
  dnf_level         Int?
  last_image_url    String?
  last_ai_image_url String?
  last_analysis     String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  dnf_battle_tags             String[]  @default([])
  dnf_battle_stats            Json?
  dnf_battle_stats_version    Int       @default(1)
  dnf_battle_stats_updated_at DateTime? @db.Timestamptz(6)

  user_characters user_characters[]

  @@unique([server_id, dnf_character_id], map: "character_profiles_server_dnf_uidx")
  @@index([server_id, character_name], map: "character_profiles_server_name_idx")
}

model user_characters {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String @db.Uuid
  profile_id String @db.Uuid

  // 슬롯/표시
  wins        Int     @default(0)
  is_main    Boolean @default(false)
  slot_index Int
  bg_key     String?

  // --- 성장 --- 이는 PVP에서도 어느정도 영향이 가야함
  level       Int    @default(1)
  level_xp    BigInt @default(0) //캐릭터 경험치 1~2,147,483,647까지 1레벨부터 100레벨까지 가능하게 수치는 조정
  stat_points Int    @default(0) //캐릭터 스탯을 조정할 수 있는 xp(이걸로 체력, 공격력등을 올릴 수 있음)

  // 유저 캐릭터 고유의 전투 성향, 스텟(처음 character_profiles의 정보를 가져오지만 등록된 유저에 따라서 스텟과 성향은 재설정할 수 있음)
  user_battle_tags             String[]  @default([])
  user_battle_stats            Json?
  user_battle_stats_version    Int       @default(1)
  user_battle_stats_updated_at DateTime? @db.Timestamptz(6)

  // --- 피로도(캐릭터 단위, PVP 1회당 -1, 자연회복은 cap_base까지만) ---
  fatigue            Int      @default(30) // 오버캡 가능(물약)
  fatigue_cap_base   Int      @default(30) // 자연회복 상한(기본 30)
  fatigue_updated_at DateTime @default(now()) @db.Timestamptz(6)

  // --- 캐릭터 잠금(죽으면 10분) ---
  locked_until DateTime? @db.Timestamptz(6)

  // --- PVP 아레나 (레벨업 X, 전적/연승/레이팅) ---
  arena_bucket         Int @default(1)
  arena_rating         Int @default(1200)
  arena_wins           Int @default(0)
  arena_losses         Int @default(0)
  arena_streak_current Int @default(0)
  arena_streak_best    Int @default(0)

  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  profile character_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  user    app_users          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  battles_as_challenger battles[]               @relation("battles_challenger_uc")
  battles_as_target     battles[]               @relation("battles_target_uc")
  battles_as_winner     battles[]               @relation("battles_winner_uc")
  equipment             user_equipment[]
  allocations           user_stat_allocations[]

  @@unique([user_id, profile_id])
  @@unique([user_id, slot_index])
  @@index([user_id])
  @@index([profile_id])
  @@index([arena_bucket, arena_rating])
}

enum ItemType {
  CONSUMABLE
  MATERIAL
  EQUIPMENT
  ETC
}

model items {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key        String   @unique
  name       String
  type       ItemType
  stackable  Boolean  @default(true)
  meta_json  Json?
  created_at DateTime @default(now()) @db.Timestamptz(6)

  inventories   user_inventory[]
  monster_drops monster_drops[]
}

model user_inventory {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  item_id    String   @db.Uuid
  qty        Int      @default(0)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  user        app_users        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  item        items            @relation(fields: [item_id], references: [id], onDelete: Cascade)
  equipped_in user_equipment[]

  @@unique([user_id, item_id])
  @@index([user_id])
  @@index([item_id])
}

model monsters {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key        String   @unique
  name       String
  level      Int
  exp_reward Int
  gold_min   Int      @default(0)
  gold_max   Int      @default(0)
  meta_json  Json?
  created_at DateTime @default(now()) @db.Timestamptz(6)

  drops monster_drops[]
}

model monster_drops {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  monster_id String @db.Uuid
  item_id    String @db.Uuid

  drop_rate Float // 0~1
  qty_min   Int   @default(1)
  qty_max   Int   @default(1)

  monster monsters @relation(fields: [monster_id], references: [id], onDelete: Cascade)
  item    items    @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@index([monster_id])
  @@index([item_id])
}

enum EquipSlot {
  WEAPON
  TOP
  SHOULDER
  BOTTOM
  BELT
  SHOES
  NECKLACE
  BRACELET
  RING
  SUPPORT
  MAGIC_STONE
  EARRING
}

model user_equipment {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_character_id String    @db.Uuid
  slot              EquipSlot
  user_inventory_id String    @db.Uuid
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  uc  user_characters @relation(fields: [user_character_id], references: [id], onDelete: Cascade)
  inv user_inventory  @relation(fields: [user_inventory_id], references: [id], onDelete: Cascade)

  @@unique([user_character_id, slot]) // ✅ 슬롯당 1개
  @@unique([user_character_id, user_inventory_id])
  @@index([user_character_id])
  @@index([user_inventory_id])
}

enum StatKey {
  HP
  POWER
  DEFENSE
  SPEED
  PHYSICAL
  MAGIC
  RANGE
}

model user_stat_allocations {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_character_id String   @db.Uuid
  stat              StatKey
  points            Int      @default(0)
  updated_at        DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  uc user_characters @relation(fields: [user_character_id], references: [id], onDelete: Cascade)

  @@unique([user_character_id, stat]) // 캐릭터당 각 스탯 1행
  @@index([user_character_id])
}

// insert into items (key, name, type, stackable, meta_json)
// values
// ('revive_coin', '부활 코인', 'CONSUMABLE', true, '{"effect":"UNLOCK_CHARACTER"}'),
// ('fatigue_potion_10', '피로도 물약(10)', 'CONSUMABLE', true, '{"effect":"ADD_FATIGUE","amount":10}'),
// ('fatigue_potion_30', '피로도 물약(30)', 'CONSUMABLE', true, '{"effect":"ADD_FATIGUE","amount":30}')
// on conflict (key) do nothing;
